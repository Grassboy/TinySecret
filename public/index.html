<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinySecret - ç«¯å°ç«¯åŠ å¯†èŠå¤©</title>
    <script>
        (function() {
            // å‹•æ…‹è¨ˆç®— base path
            var path = window.location.pathname;
            // ç§»é™¤æœ«å°¾çš„æ–œç·šï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            if (path.endsWith('/') && path !== '/') {
                path = path.slice(0, -1);
            }
            // ç¢ºä¿ path ä»¥ / çµå°¾ï¼ˆé™¤äº†æ ¹è·¯å¾‘ï¼‰
            if (path !== '/') {
                path = path + '/';
            }
            // å°æ–¼ /tinySecret/ï¼Œbase å°±æ˜¯ /tinySecret/
            // å°æ–¼ /ï¼Œbase å°±æ˜¯ /
            var base = window.location.origin + path;
            document.write('<base href="' + base + '">');
            document.write('<link rel="stylesheet" href="' + base + 'styles.css">');
            document.write('<script src="' + base + 'crypto.js"><\/script>');
        })();
    </script>
</head>
<body>
    <div class="container">
        <div class="hero">
            <h1>ğŸ”’ TinySecret</h1>
            <p class="subtitle">ç«¯å°ç«¯åŠ å¯†çš„å³æ™‚èŠå¤©</p>
            <p class="subtitle-small">ä¼ºæœå™¨ç„¡æ³•è§£å¯†ä½ çš„è¨Šæ¯</p>
        </div>

        <div class="card">
            <h2>é–‹å§‹å®‰å…¨å°è©±</h2>
            <p class="description">é»æ“Šä¸‹æ–¹æŒ‰éˆ•å‰µå»ºåŠ å¯†èŠå¤©å®¤ï¼Œåˆ†äº«é€£çµçµ¦å°æ–¹å³å¯é–‹å§‹å°è©±</p>
            
            <button id="createRoomBtn" class="btn-primary">
                å‰µå»ºèŠå¤©å®¤
            </button>
        </div>

        <div class="features">
            <div class="feature">
                <div class="feature-icon">ğŸ”</div>
                <h3>ç«¯å°ç«¯åŠ å¯†</h3>
                <p>ä½¿ç”¨ RSA-2048 åŠ å¯†ï¼Œä¼ºæœå™¨åªè½‰ç™¼å¯†æ–‡</p>
            </div>
            <div class="feature">
                <div class="feature-icon">ğŸš«</div>
                <h3>ä¸å­˜è¨Šæ¯</h3>
                <p>ä¼ºæœå™¨ä¸å„²å­˜ä»»ä½•è¨Šæ¯å…§å®¹</p>
            </div>
            <div class="feature">
                <div class="feature-icon">â±ï¸</div>
                <h3>è‡ªå‹•éæœŸ</h3>
                <p>15åˆ†é˜ç„¡æ´»å‹•è‡ªå‹•æ¸…é™¤æˆ¿é–“</p>
            </div>
        </div>
    </div>
    <script>
        document.getElementById('createRoomBtn').addEventListener('click', async () => {
            const btn = document.getElementById('createRoomBtn');
            btn.disabled = true;
            btn.textContent = 'ç”Ÿæˆé‡‘é‘°ä¸­...';

            try {
                // ç”Ÿæˆ RSA é‡‘é‘°å°
                const keyPair = await CryptoHelper.generateKeyPair();
                const publicKeyBase64 = await CryptoHelper.exportPublicKey(keyPair.publicKey);
                const privateKeyBase64 = await CryptoHelper.exportPrivateKey(keyPair.privateKey);
                
                btn.textContent = 'å‰µå»ºæˆ¿é–“ä¸­...';
                
                // ç²å– base path
                const basePath = document.querySelector('base')?.getAttribute('href') || '/';
                const apiPath = basePath.replace(/\/$/, '') + '/api/create-room';
                
                // å‰µå»ºæˆ¿é–“
                const response = await fetch(apiPath, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ publicKey: publicKeyBase64 })
                });

                const { roomId } = await response.json();
                
                // å„²å­˜é‡‘é‘°åˆ° localStorage
                localStorage.setItem(`tinySecret_room_${roomId}_privateKey`, privateKeyBase64);
                localStorage.setItem(`tinySecret_room_${roomId}_publicKey`, publicKeyBase64);
                localStorage.setItem(`tinySecret_room_${roomId}_role`, 'creator');
                
                // è·³è½‰åˆ°æˆ¿é–“
                window.location.href = basePath.replace(/\/$/, '') + '/' + roomId;
            } catch (error) {
                console.error('å‰µå»ºæˆ¿é–“å¤±æ•—:', error);
                alert('å‰µå»ºæˆ¿é–“å¤±æ•—ï¼Œè«‹é‡è©¦');
                btn.disabled = false;
                btn.textContent = 'å‰µå»ºèŠå¤©å®¤';
            }
        });
    </script>
</body>
</html>
